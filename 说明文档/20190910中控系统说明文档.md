# 20190910中控系统说明文档

**中控系统说明**
<a name="aPrx8"></a>
# 一、系统核心逻辑概述
 <br />中控系统主要分为客户端（包括Web端、正常连接设备和三方设备等）、Server服务端和数据服务中心三个部分，如图1所示：<br />![](https://cdn.nlark.com/yuque/0/2019/jpeg/446469/1573183286703-97eac139-3bdf-46b3-b533-032adf69bbe1.jpeg#height=312&width=336)<br />图1 中控系统核心逻辑<br /> <br />解释：<br />1)      Web端分为控制界面和后台管理系统。控制界面主要用来操作场馆设备，后台管理系统用来配置整个场馆及其设备的基础信息、逻辑关系等。<br />2)      所有通过Socket连接Server的都可以称之为设备。能够响应Server请求的可以称之为正常设备，被动接收指令的为三方设备。<br />3)      Server服务端主要负责web端和硬件设备之间的通信，实时响应命令的返回结果；<br />4)      数据库主要负责保存整个系统的数据信息。<br /> 
<a name="D2TAZ"></a>
# 二、后台管理系统功能描述
 <br />中控后台管理系统主要配置系统信息，主要分为四个部分：展项类型、展项、设备和命令，如图2所示：<br />![](https://cdn.nlark.com/yuque/0/2019/jpeg/446469/1573183286833-f3f403c6-d512-4d04-9774-262d79a1b273.jpeg#height=266&width=197)<br />图2 后台管理系统功能列表<br /> <br />1)      基于展项的物理位置和功能，展项类型分为固定类型和自定义类型；<br />2)      展项作为整个系统的核心模块，主要由展项命令和设备列表组成：<br />①　展项命令显示的是展项下所有基本命令的组合，如灯光全开/关；<br />②　设备列表显示的是展项下的所有设备和每个设备对应的基本命令；<br />3)      设备管理主要显示展馆内所有的设备信息；<br />4)      命令管理主要显示由命令格式字典生成的命令，主要分为：展项基本命令和设备基本命令。展项基本命令属于群发命令，而设备基本命令是带参数或变量的单个设备命令。<br /> 
<a name="mc8lo"></a>
# 三、发送命令的生成逻辑
![](https://cdn.nlark.com/yuque/0/2019/jpeg/446469/1573183286924-d16f00d3-1868-4565-aeb7-f4c407eea9ca.jpeg#height=63&width=415)<br />图3 命令生成逻辑<br /> <br /> <br /> <br />详见命令逻辑文档。<br /> 
<a name="KqhsD"></a>
# 四、数据通讯规则
![](https://cdn.nlark.com/yuque/0/2019/jpeg/446469/1573183287037-5670b308-5532-4e23-ad5f-5b9ae0891122.jpeg#height=132&width=425)<br />图4 客户端之间信息传输<br /> <br /> <br />![](https://cdn.nlark.com/yuque/0/2019/jpeg/446469/1573183287140-dea4e479-56cf-4310-a756-b59bcbfceaae.jpeg#height=109&width=256)<br /> <br />图5 客户端与服务端之间的信息传输<br /> <br />图4为客户端之间信息传输，图5为客户端与服务端之间的信息传输。一般情况下服务端不用发送命令给客户端。<br /> 
<a name="x0Juz"></a>
# 五、客户端连接Server端的运行逻辑
所有正常设备都应该有自己IP地址下唯一的DeviceId,并且将之发送给Server端，和服务器断开连接的情况下需要重新发送。DeviceId是IP地址下的唯一标识。<br />（解释：特殊情况下也可以有相同的DeviceId,可以用来批量操作设备。）<br /> <br />服务端识别客户端逻辑（了解）：<br />1)      连接Server以后服务器识别为连接中设备，<br />2)      当客户端发送DeviceId给Server端以后，连接完成。<br />3)      服务端根据客户端IP地址和DeviceId在数据库中查找该设备是否添加到数据库中。<br /> <br />客户端连接Server端逻辑如下图所示（客户端必须实现）：<br /> <br /> <br /> <br /> <br />![](https://cdn.nlark.com/yuque/0/2019/jpeg/446469/1573183287290-7e7cc9bf-3c09-4f17-a0c7-e60f0683d4fd.jpeg#height=302&width=306)<br />图6 客户端连接逻辑<br /> <br /> <br /> <br />1.  开发者权限<br />（只能看到自己添加的）<br />1）添加设备到数据库<br />已添加的可以看到状态，并且能够编辑<br />2）Test<br />出现自己添加的设备，和自己的命令<br />3）设备管理<br />只能看到自己的<br />4）命令管理<br />只有设备基本命令可用，只能看到自己的<br />5）字典管理、命令格式管理<br />只能看到自己的。<br /> <br /> <br />其它不可见<br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> <br /> 
